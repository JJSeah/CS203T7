


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=windows-1252"> 
  <title>Coverage Report > VoronoiService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.example.electric.service</a>
</div>

<h1>Coverage Summary for Class: VoronoiService (com.example.electric.service)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">VoronoiService</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    20%
  </span>
  <span class="absValue">
    (1/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    1.3%
  </span>
  <span class="absValue">
    (1/75)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.example.electric.service;
&nbsp;
&nbsp;import com.example.electric.model.*;
&nbsp;import com.example.electric.service.inter.VoronoiServiceInter;
&nbsp;import org.locationtech.jts.geom.*;
&nbsp;import org.locationtech.jts.operation.distance.DistanceOp;
&nbsp;import org.locationtech.jts.triangulate.DelaunayTriangulationBuilder;
&nbsp;import org.locationtech.jts.triangulate.VoronoiDiagramBuilder;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;
&nbsp;import java.sql.Time;
&nbsp;import java.time.Duration;
&nbsp;import java.time.LocalDate;
&nbsp;import java.time.LocalTime;
&nbsp;import java.time.format.DateTimeFormatter;
&nbsp;import java.time.temporal.ChronoUnit;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.List;
&nbsp;
&nbsp;@Service
<b class="fc">&nbsp;public class VoronoiService implements VoronoiServiceInter {</b>
&nbsp;    @Autowired
&nbsp;    private StationService stationService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private AppointmentService appointmentService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private DistanceMatrixService distanceMatrixService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private UserService userService;
&nbsp;
&nbsp;    /**
&nbsp;     * Find Closest Charging Station
&nbsp;     *
&nbsp;     * This method determines the closest available charging station based on a specified location
&nbsp;     * (latitude and longitude) using Voronoi Diagrams. The function first calculates the current time
&nbsp;     * rounded to the nearest 5-minute interval and defines a time window for station availability.
&nbsp;     * It then retrieves a list of stations available during this time period and extracts their
&nbsp;     * coordinates.
&nbsp;     *
&nbsp;     * Next, it uses Delaunay triangulation to create a Voronoi diagram based on the station coordinates.
&nbsp;     * The method calculates the Voronoi cell associated with the input location and identifies the
&nbsp;     * station closest to this cell.
&nbsp;     *
&nbsp;     * @param latitude The latitude coordinate of the user&#39;s location.
&nbsp;     * @param longitude The longitude coordinate of the user&#39;s location.
&nbsp;     * @return The Station object representing the closest available charging station or null if no
&nbsp;     * stations are available.
&nbsp;     */
&nbsp;    public Station findClosestStation(double latitude, double longitude) {
&nbsp;        //Get current time rounded to 5 minutes
<b class="nc">&nbsp;        LocalTime currentTime = LocalTime.now();</b>
<b class="nc">&nbsp;        int minute = currentTime.getMinute();</b>
<b class="nc">&nbsp;        int roundedMinute = (minute / 5) * 5;</b>
&nbsp;
<b class="nc">&nbsp;        LocalTime roundedStartTime = currentTime.withMinute(roundedMinute).withSecond(00);</b>
<b class="nc">&nbsp;        String startTime = roundedStartTime.format(DateTimeFormatter.ofPattern(&quot;HH:mm:ss&quot;));</b>
&nbsp;
&nbsp;        //Calculate end time
<b class="nc">&nbsp;        LocalTime start = LocalTime.parse(startTime);</b>
<b class="nc">&nbsp;        LocalTime end = start.plus(3, ChronoUnit.HOURS);</b>
<b class="nc">&nbsp;        String endTime = end.format(DateTimeFormatter.ofPattern(&quot;HH:mm:ss&quot;));</b>
&nbsp;
&nbsp;        //Get current date
<b class="nc">&nbsp;        LocalDate currentDate = LocalDate.now();</b>
<b class="nc">&nbsp;        String date = currentDate.format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd&quot;));</b>
&nbsp;
&nbsp;        //Use Voronoi Diagrams to find closest station
<b class="nc">&nbsp;        List&lt;Station&gt; availableStations = appointmentService.getAvailableStationsAndChargers(startTime,endTime,date);</b>
<b class="nc">&nbsp;        Coordinate[] stationCoordinates = new Coordinate[availableStations.size()];</b>
&nbsp;        //Mapped into stationCoordinates
<b class="nc">&nbsp;        for (int i = 0; i &lt; availableStations.size(); i++) {</b>
<b class="nc">&nbsp;            Station station = availableStations.get(i);</b>
<b class="nc">&nbsp;            Coordinate coordinate = new Coordinate(station.getLatitude(), station.getLongitude());</b>
<b class="nc">&nbsp;            stationCoordinates[i] = coordinate;</b>
&nbsp;        }
&nbsp;
&nbsp;        // Create a DelaunayTriangulationBuilder
<b class="nc">&nbsp;        DelaunayTriangulationBuilder delaunayBuilder = new DelaunayTriangulationBuilder();</b>
<b class="nc">&nbsp;        delaunayBuilder.setSites(Arrays.asList(stationCoordinates));</b>
&nbsp;
&nbsp;        // Get the Delaunay triangulation
<b class="nc">&nbsp;        Geometry delaunayTriangulation = delaunayBuilder.getTriangles(new GeometryFactory());</b>
&nbsp;
&nbsp;        // Create a VoronoiDiagramBuilder
<b class="nc">&nbsp;        VoronoiDiagramBuilder voronoiBuilder = new VoronoiDiagramBuilder();</b>
<b class="nc">&nbsp;        voronoiBuilder.setSites(delaunayTriangulation);</b>
&nbsp;
<b class="nc">&nbsp;        Geometry diagram = voronoiBuilder.getDiagram(new GeometryFactory());</b>
&nbsp;
<b class="nc">&nbsp;        Polygon cell = findCell(diagram, new Coordinate(latitude, longitude));</b>
<b class="nc">&nbsp;        Coordinate closestStationCoordinates = findWithinCell(cell, stationCoordinates);</b>
<b class="nc">&nbsp;        Station closestStation = null;</b>
&nbsp;
&nbsp;        try {
<b class="nc">&nbsp;            closestStation = stationService.getStationByCoordinate(closestStationCoordinates.getX(), closestStationCoordinates.getY());</b>
<b class="nc">&nbsp;        } catch (NullPointerException e) {</b>
<b class="nc">&nbsp;            System.out.println(&quot;No stations available, should return null&quot;);</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return closestStation;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Find Cell
&nbsp;     *
&nbsp;     * Finds the Voronoi cell associated with a specific station coordinate in the Voronoi diagram.
&nbsp;     *
&nbsp;     * @param diagram The Voronoi diagram as a Geometry object.
&nbsp;     * @param stationCoordinate The coordinate of the station for which to find the cell.
&nbsp;     * @return The Polygon representing the Voronoi cell associated with the station.
&nbsp;     */
&nbsp;    public Polygon findCell(Geometry diagram, Coordinate stationCoordinate) {
<b class="nc">&nbsp;        GeometryFactory factory = new GeometryFactory();</b>
&nbsp;//        Coordinate[] coords = new Coordinate[]{stationCoordinate};
<b class="nc">&nbsp;        Geometry stationPoint = factory.createPoint(stationCoordinate);</b>
<b class="nc">&nbsp;        GeometryCollection polygons = factory.createGeometryCollection();</b>
&nbsp;
&nbsp;        // Find the cell associated with the station by finding the closest polygon in the Voronoi diagram
&nbsp;        try {
<b class="nc">&nbsp;            polygons = (GeometryCollection) diagram;</b>
<b class="nc">&nbsp;        } catch (ClassCastException e) {</b>
<b class="nc">&nbsp;            System.out.println(&quot;diagram is not a GeometryCollection&quot;);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        double minDistance = Double.POSITIVE_INFINITY;</b>
<b class="nc">&nbsp;        Polygon nearestCell = null;</b>
&nbsp;
<b class="nc">&nbsp;        for (int i = 0; i &lt; polygons.getNumGeometries(); i++) {</b>
<b class="nc">&nbsp;            Polygon cell = (Polygon) polygons.getGeometryN(i);</b>
<b class="nc">&nbsp;            double distance = DistanceOp.distance(stationPoint, cell);</b>
<b class="nc">&nbsp;            if (distance &lt; minDistance) {</b>
<b class="nc">&nbsp;                minDistance = distance;</b>
<b class="nc">&nbsp;                nearestCell = cell;</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return nearestCell;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Find Within Cell
&nbsp;     *
&nbsp;     * Finds the coordinate within a Voronoi cell that is closest to the given coordinates.
&nbsp;     *
&nbsp;     * @param cell The Voronoi cell represented as a Polygon.
&nbsp;     * @param coordinates An array of coordinates to search for within the cell.
&nbsp;     * @return The Coordinate within the cell that is closest to the given coordinates.
&nbsp;     */
&nbsp;    public Coordinate findWithinCell(Polygon cell, Coordinate[] coordinates) {
<b class="nc">&nbsp;        Coordinate nearestStation = null;</b>
<b class="nc">&nbsp;        double minDistance = Double.MAX_VALUE;</b>
&nbsp;
<b class="nc">&nbsp;        for (Coordinate coordinate : coordinates) {</b>
&nbsp;            // Check if the hospital coordinate is inside the Voronoi cell
<b class="nc">&nbsp;            if (cell.contains(new GeometryFactory().createPoint(coordinate))) {</b>
&nbsp;                // Calculate the distance between the station and the hospital
<b class="nc">&nbsp;                double distance = cell.distance(new GeometryFactory().createPoint(coordinate));</b>
<b class="nc">&nbsp;                if (distance &lt; minDistance) {</b>
<b class="nc">&nbsp;                    minDistance = distance;</b>
<b class="nc">&nbsp;                    nearestStation = coordinate;</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return nearestStation;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Auto-book Appointment
&nbsp;     *
&nbsp;     * Automatically books a charging appointment for a user based on location, time, and car details.
&nbsp;     *
&nbsp;     * @param latitude The latitude coordinate of the location.
&nbsp;     * @param longitude The longitude coordinate of the location.
&nbsp;     * @param startTime The start time of the appointment.
&nbsp;     * @param endTime The end time of the appointment.
&nbsp;     * @param dateNow The current date.
&nbsp;     * @param car The Car object for which the appointment is made.
&nbsp;     * @param userEmail The email address of the user making the appointment.
&nbsp;     * @return The Appointment object representing the booked appointment.
&nbsp;     */
&nbsp;
&nbsp;    public Appointment autobookAppointment(double latitude, double longitude, String startTime, String endTime, String dateNow, Car car, String userEmail) {
&nbsp;        //Find station
<b class="nc">&nbsp;        Station closestStation = this.findClosestStation(latitude,longitude);</b>
&nbsp;
&nbsp;        //Find date and time
<b class="nc">&nbsp;        LocalTime start = LocalTime.parse(startTime);</b>
<b class="nc">&nbsp;        LocalTime end = LocalTime.parse(endTime);</b>
<b class="nc">&nbsp;        Duration duration = Duration.between(start,end);</b>
<b class="nc">&nbsp;        LocalTime timeBetween = LocalTime.MIDNIGHT</b>
<b class="nc">&nbsp;                .plusHours(duration.toHours())</b>
<b class="nc">&nbsp;                .plusMinutes(duration.toMinutesPart())</b>
<b class="nc">&nbsp;                .plusSeconds(duration.toSecondsPart());</b>
&nbsp;
&nbsp;        //Find cost
<b class="nc">&nbsp;        double cost = distanceMatrixService.calculateCostOfCharging(car);</b>
&nbsp;
&nbsp;        //Find user
<b class="nc">&nbsp;        User user = userService.getUserByEmail(userEmail);</b>
&nbsp;
&nbsp;        //Find charger
<b class="nc">&nbsp;        List&lt;Charger&gt; chargers = closestStation.getChargers();</b>
&nbsp;
&nbsp;        //Appointment object
<b class="nc">&nbsp;        Appointment appointment = new Appointment(1,</b>
<b class="nc">&nbsp;                Time.valueOf(timeBetween),</b>
<b class="nc">&nbsp;                Time.valueOf(start),</b>
<b class="nc">&nbsp;                Time.valueOf(end),</b>
<b class="nc">&nbsp;                java.sql.Date.valueOf(dateNow),</b>
<b class="nc">&nbsp;                cost,</b>
&nbsp;                &quot;Active&quot;,
&nbsp;                closestStation,
&nbsp;                user,
<b class="nc">&nbsp;                chargers.get(0));</b>
&nbsp;
<b class="nc">&nbsp;        return appointmentService.addAppointment(appointment);</b>
&nbsp;    }
&nbsp;
&nbsp;}
&nbsp;
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-10-30 13:31</div>
</div>
</body>
</html>
